<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blind Date | Aura Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --rose: #f43f5e; --border: rgba(255, 255, 255, 0.15); --glass: rgba(10, 10, 20, 0.85); }
        body { margin: 0; font-family: 'Poppins', sans-serif; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #020617; }
        
        /* Animated Background */
        body::before { content: ""; position: absolute; width: 250%; height: 250%; background: conic-gradient(from 180deg at 50% 50%, #f43f5e, #881337, #1e1b4b, #020617, #f43f5e); animation: rotate 20s linear infinite; opacity: 0.45; z-index: -1; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .app-card { background: var(--glass); backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px); width: 100%; max-width: 440px; height: 95vh; display: flex; flex-direction: column; border-radius: 35px; border: 1px solid var(--border); box-shadow: 0 30px 60px rgba(0,0,0,0.7); margin: 10px; position: relative; overflow: hidden; }
        
        #vibe-bar { background: linear-gradient(90deg, transparent, rgba(244,63,94,0.3), transparent); padding: 10px; text-align: center; border-bottom: 1px solid var(--border); display: none; }
        #vibe-text { font-size: 11px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px var(--rose); }
        .meter-box { height: 3px; background: rgba(255,255,255,0.1); width: 60%; margin: 6px auto 0 auto; border-radius: 10px; overflow: hidden; }
        #vibe-meter { height: 100%; width: 0%; background: var(--rose); transition: 1s; box-shadow: 0 0 10px var(--rose); }

        .header { padding: 15px; text-align: center; border-bottom: 1px solid var(--border); }
        .header h2 { margin: 0; font-size: 1.3rem; font-weight: 900; color: white; letter-spacing: 2px; }
        #timer-display { background: var(--rose); color: white; padding: 3px 12px; border-radius: 20px; font-size: 10px; font-weight: 900; margin-top: 8px; display: none; }

        #ice-btn { position: absolute; top: 100px; right: 15px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: white; padding: 6px 12px; border-radius: 20px; font-size: 10px; cursor: pointer; z-index: 100; backdrop-filter: blur(10px); display: none; }

        /* Login Screen */
        #login-screen { padding: 40px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .g-grid { display: flex; gap: 15px; margin: 25px 0; }
        .g-opt { flex: 1; padding: 15px; border-radius: 15px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: #94a3b8; font-weight: 700; cursor: pointer; transition: 0.3s; text-align: center; }
        .g-opt.active { background: var(--rose); color: white; border-color: var(--rose); box-shadow: 0 0 20px rgba(244, 63, 94, 0.4); }

        input { width: 100%; padding: 18px; border-radius: 15px; border: 1px solid var(--border); background: rgba(0,0,0,0.5); color: white; outline: none; margin-bottom: 20px; box-sizing: border-box; font-size: 1rem; }
        .btn-main { width: 100%; padding: 18px; border-radius: 15px; border: none; background: var(--rose); color: white; font-weight: 900; cursor: pointer; letter-spacing: 1px; }

        /* Chat Styles */
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { padding: 12px 18px; border-radius: 22px; font-size: 14px; max-width: 80%; line-height: 1.5; color: white; animation: slideUp 0.3s ease; position: relative; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg.me { align-self: flex-end; background: var(--rose); border-bottom-right-radius: 2px; }
        .msg.them { align-self: flex-start; background: rgba(255,255,255,0.12); border-bottom-left-radius: 2px; }
        
        /* Admin JOIN FIX: Ensure button is always accessible */
        .admin-msg-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; width: 100%; }
        .admin-room-label { font-size: 9px; opacity: 0.7; text-transform: uppercase; word-break: break-all; flex: 1; margin-right: 10px; }
        .join-link { color: var(--rose); cursor: pointer; font-weight: 900; font-size: 11px; white-space: nowrap; flex-shrink: 0; padding: 2px 5px; }
        
        .msg.challenge { align-self: center; width: 90%; background: linear-gradient(45deg, #7c3aed, #f43f5e); text-align: center; font-weight: 900; border-radius: 15px; font-size: 13px; border: 1px solid rgba(255,255,255,0.3); }
        .msg.system { align-self: center; background: rgba(255,255,255,0.05); font-size: 10px; text-transform: uppercase; color: #94a3b8; padding: 5px 12px; border-radius: 10px; }

        .input-area { padding: 15px; background: rgba(0,0,0,0.3); display: flex; gap: 10px; border-top: 1px solid var(--border); }
        .send-btn { background: var(--rose); border: none; border-radius: 50%; width: 50px; height: 50px; color: white; cursor: pointer; font-size: 1.4rem; flex-shrink: 0; }
        
        #admin-panel { padding: 10px; display: none; gap: 10px; justify-content: center; background: rgba(244,63,94,0.15); border-bottom: 1px solid var(--border); }
        .a-btn { padding: 8px 15px; border-radius: 12px; border: none; color: white; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-card">
    <div id="vibe-bar">
        <span id="vibe-text">SYNCING VIBE...</span>
        <div class="meter-box"><div id="vibe-meter"></div></div>
    </div>
    
    <div class="header">
        <h2 id="top-title">BLIND DATE</h2>
        <center><div id="timer-display">00:00</div></center>
    </div>

    <button id="ice-btn" onclick="getIcebreaker()">üí° ICEBREAKER</button>

    <div id="admin-panel">
        <button class="a-btn" style="background:#1e293b; display:none;" id="back-btn" onclick="goBack()">üîô</button>
        <button class="a-btn" style="background:#7c3aed" onclick="triggerChallenge()">üéØ</button>
        <button class="a-btn" style="background:#ea580c" onclick="adminAct('broadcast', prompt('Msg:'))">üì¢</button>
        <button class="a-btn" style="background:#be123c" onclick="adminAct('wipeAll')">üóëÔ∏è</button>
    </div>

    <div id="login-screen">
        <h1 style="color:white; font-weight:900;">WELCOME</h1>
        <div class="g-grid">
            <div class="g-opt" id="btn-Male" onclick="setG('Male')">MALE</div>
            <div class="g-opt" id="btn-Female" onclick="setG('Female')">FEMALE</div>
        </div>
        <input id="mid" placeholder="ENTER MATCH ID">
        <button class="btn-main" onclick="start()">JOIN THE VOID</button>
    </div>

    <div id="chat-screen" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
        <div id="msg-box" class="messages"></div>
        <div class="input-area">
            <input id="txt" placeholder="Whisper something mystery...">
            <button class="send-btn" onclick="send()">‚û§</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzN4TP7uLP4iox7o0jRbG4vC2wBIT7PFRbQwuVd3FByRMGsqU-eSLJjrewR6BTw_PaC/exec"; 
    const ADMIN_PASS = "ADITYASINGH710";
    let mid = "", gender = "", isAdmin = false, lastData = "", timerInt = null, challengeStep = 0, viewMode = "chat";

    function setG(g) { gender = g; document.querySelectorAll('.g-opt').forEach(o => o.classList.remove('active')); document.getElementById('btn-'+g).classList.add('active'); }

    function start() {
        mid = document.getElementById("mid").value.trim().toUpperCase();
        if (mid === ADMIN_PASS) { 
            isAdmin = true; gender = "ADMIN"; viewMode = "dashboard";
            setupUI("üõ†Ô∏è ADMIN DASHBOARD"); 
            setInterval(() => { if(viewMode === "dashboard") loadAdmin(); else loadChat(); }, 3000); 
            return; 
        }
        if (!mid || !gender) return alert("Select Gender & ID");

        fetch(`${API_URL}?matchId=${mid}`).then(r => r.text()).then(vibe => {
            if (vibe !== "INVALID") {
                document.getElementById("vibe-text").innerText = "MATCH VIBE: " + vibe;
                document.getElementById("vibe-bar").style.display = "block";
                document.getElementById("ice-btn").style.display = "block";
                setupUI("MATCH ACTIVE");
                fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "joinSession", matchId: mid, sender: gender }) });
                setInterval(loadChat, 4000);
            } else alert("Invalid ID");
        });
    }

    function setupUI(title) {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("chat-screen").style.display = "flex";
        if (document.getElementById("top-title")) document.getElementById("top-title").innerText = title;
        if (isAdmin) document.getElementById("admin-panel").style.display = "flex";
    }

    function getIcebreaker() { fetch(`${API_URL}?mode=icebreaker`).then(r => r.text()).then(q => alert("üí° ICEBREAKER:\n\n" + q)); }

    function triggerChallenge() {
        const c = ["üéØ CHALLENGE: Tell your partner one thing you like about their vibe!", "üéØ CHALLENGE: First impressions of your match?", "üéØ CHALLENGE: Send an emoji for your mood!"];
        adminAct('challenge', c[Math.floor(Math.random()*c.length)]);
    }

    function send() {
        const t = document.getElementById("txt"), v = t.value.trim();
        if (!v) return;
        const box = document.getElementById("msg-box"), d = document.createElement("div");
        d.className = "msg me"; d.innerHTML = `<b>${gender}</b><br>${v}`;
        box.appendChild(d); box.scrollTop = box.scrollHeight;
        t.value = "";
        fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ matchId: mid, sender: gender, message: v }) });
    }

    function loadChat() {
        fetch(`${API_URL}?matchId=${mid}&mode=fetch`).then(r => r.json()).then(data => {
            if (JSON.stringify(data) === lastData) return; lastData = JSON.stringify(data);
            const box = document.getElementById("msg-box");
            box.innerHTML = data.map(m => {
                if(m.message.includes("TIMER_START:")) { runTimer(m.message.split(":")[1]); return ""; }
                let cls = m.sender === "üéØ CHALLENGE" ? "msg challenge" : (m.sender === "üì¢ ADMIN" ? "msg challenge" : (m.sender === "SYSTEM" ? "msg system" : (m.sender === gender ? "msg me" : "msg them")));
                return `<div class="${cls}"><b>${m.sender}</b><br>${m.message}</div>`;
            }).join("");
            box.scrollTop = box.scrollHeight;
            const progress = Math.min(data.length * 7, 100);
            document.getElementById("vibe-meter").style.width = progress + "%";
            if(progress >= 50 && challengeStep === 0 && !isAdmin) { triggerChallenge(); challengeStep = 1; }
        });
    }

    function adminJoin(roomID) {
        mid = roomID;
        viewMode = "chat";
        document.getElementById("top-title").innerText = "JOINED: " + roomID;
        document.getElementById("back-btn").style.display = "inline-block";
        loadChat();
    }

    function goBack() {
        viewMode = "dashboard";
        document.getElementById("top-title").innerText = "üõ†Ô∏è ADMIN DASHBOARD";
        document.getElementById("back-btn").style.display = "none";
        loadAdmin();
    }

    function runTimer(mins) {
        if(timerInt) clearInterval(timerInt);
        let time = mins * 60, disp = document.getElementById("timer-display");
        disp.style.display = "inline-block";
        timerInt = setInterval(() => {
            let m = Math.floor(time / 60), s = time % 60;
            disp.innerText = `EXPIRING: ${m}:${s < 10 ? '0'+s : s}`;
            if (--time < 0) { clearInterval(timerInt); disp.innerText = "EXPIRED"; }
        }, 1000);
    }

    function adminAct(action, val) { fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action, message: val, matchId: mid }) }); }

    function loadAdmin() {
        fetch(`${API_URL}?mode=adminFetch`).then(r => r.json()).then(data => {
            const box = document.getElementById("msg-box");
            // FIXED JOIN BUTTON LAYOUT
            box.innerHTML = data.map(m => `
                <div class="msg them" style="max-width:95%; width: 100%;">
                    <div class="admin-msg-header">
                        <span class="admin-room-label">Room ${m.room} | ${m.sender}</span>
                        <span class="join-link" onclick="adminJoin('${m.room}')">[JOIN]</span>
                    </div>
                    <div style="word-wrap: break-word;">${m.message}</div>
                </div>`).join("");
            box.scrollTop = box.scrollHeight;
        });
    }

    document.getElementById("txt").addEventListener("keypress", (e) => { if(e.key === "Enter") send(); });
</script>
</body>
</html>
